# Age & Gender Estimation System Configuration
# 모든 하이퍼파라미터와 경로 설정을 이 파일에서 관리합니다.

# 프로젝트 기본 설정
project:
  name: "age_gender_estimation"
  version: "1.0.0"
  seed: 42

# 데이터 경로 설정
data:
  # 학습/검증/테스트 데이터 경로
  train_path: "data/train"
  val_path: "data/val"
  test_path: "data/test"
  
  # Annotation 형식 (csv 또는 json)
  annotation_format: "csv"
  annotation_file: "annotations.csv"  # CSV 파일명 또는 JSON 파일명
  
  # 데이터셋 분할 (annotation 파일이 하나일 경우)
  train_split: 0.8
  val_split: 0.1
  test_split: 0.1

# 모델 설정
model:
  # Backbone 설정
  backbone:
    name: "efficientnet-b0"  # efficientnet-b0, efficientnet-b1, resnet18, resnet34 등
    pretrained: true
    freeze_backbone: false  # Backbone 고정 여부 (fine-tuning 시)
  
  # Feature extraction
  feature_dim: 1280  # Backbone 출력 feature dimension (자동 설정됨)
  dropout: 0.5  # Dropout 확률
  
  # Age Head 설정
  age:
    enabled: true
    num_classes: 101  # 0~100세, 1세 단위 (총 101 classes)
    min_age: 0
    max_age: 100
    hidden_dim: 512  # Hidden layer dimension
  
  # Gender Head 설정
  gender:
    enabled: true
    num_classes: 2  # Male, Female
    hidden_dim: 256  # Hidden layer dimension

# 학습 설정
training:
  # 기본 하이퍼파라미터
  batch_size: 32
  num_epochs: 100
  num_workers: 4
  pin_memory: true
  
  # Optimizer 설정
  optimizer:
    name: "adamw"  # adam, adamw, sgd
    lr: 0.001
    weight_decay: 0.0001
    momentum: 0.9  # SGD 사용 시만
  
  # Learning Rate Scheduler
  scheduler:
    name: "cosine"  # cosine, step, plateau
    # CosineAnnealingLR
    T_max: 100
    eta_min: 0.00001
    # StepLR (scheduler가 step일 경우)
    step_size: 30
    gamma: 0.1
    # ReduceLROnPlateau (scheduler가 plateau일 경우)
    factor: 0.5
    patience: 5
    # Warm-up (선택사항)
    warmup_epochs: 5
    warmup_lr: 0.0001
  
  # Loss 설정
  loss:
    # Age Loss
    age_weight: 1.0
    age_loss_type: "cross_entropy"  # cross_entropy, focal
    
    # Gender Loss
    gender_weight: 1.0
    gender_loss_type: "cross_entropy"  # cross_entropy, focal
    
    # Focal Loss 파라미터 (focal loss 사용 시)
    focal_alpha: 0.25
    focal_gamma: 2.0
  
  # Validation 설정
  val_interval: 1  # 몇 epoch마다 검증할지
  save_interval: 10  # 몇 epoch마다 체크포인트 저장할지
  
  # Early Stopping
  early_stopping:
    enabled: true
    patience: 15
    min_delta: 0.001
    monitor: "val_loss"  # val_loss, val_age_acc, val_gender_acc

# 전처리 설정
preprocessing:
  # Resize 설정
  input_size:
    width: 224
    height: 224
  
  # Normalization
  normalization:
    type: "imagenet"  # imagenet, custom, none
    mean: [0.485, 0.456, 0.406]
    std: [0.229, 0.224, 0.225]
  
  # Augmentation (학습 시에만 적용)
  augmentation:
    # Horizontal Flip
    horizontal_flip:
      enabled: true
      probability: 0.5
    
    # Rotation
    rotation:
      enabled: true
      probability: 0.5
      max_angle: 15  # degrees
    
    # Color Jitter
    color_jitter:
      enabled: true
      probability: 0.5
      brightness: 0.2
      contrast: 0.2
      saturation: 0.2
      hue: 0.1
    
    # Random Crop
    random_crop:
      enabled: false
      probability: 0.5
      scale: [0.8, 1.0]
    
    # Random Erasing (선택사항)
    random_erasing:
      enabled: false
      probability: 0.3
      scale: [0.02, 0.33]
      ratio: [0.3, 3.3]

# 경로 설정
paths:
  # 모델 가중치 저장 경로
  weights_dir: "weights"
  checkpoint_dir: "weights/checkpoints"
  
  # 결과 저장 경로
  output_dir: "results"
  log_dir: "logs"
  
  # TensorBoard 로그 (선택사항)
  tensorboard_dir: "runs"

# 하드웨어 설정
device:
  # cuda, cpu, mps (Apple Silicon)
  type: "cuda"
  device_id: 0  # GPU ID (여러 GPU 사용 시)

# 로깅 설정
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  log_file: "logs/training.log"
  console_output: true

# 평가 설정
evaluation:
  # 평가 메트릭
  metrics:
    - "age_accuracy"
    - "gender_accuracy"
    - "age_accuracy_range"  # ±5세 범위 정확도
    - "confusion_matrix"
  
  # Age 정확도 측정 범위
  age_accuracy_ranges:
    - 1   # ±1세 범위
    - 3   # ±3세 범위
    - 5   # ±5세 범위 (채택)
    - 10  # ±10세 범위
    - 15  # ±15세 범위
  
  # 결과 저장
  save_predictions: true
  predictions_file: "results/predictions.csv"

# 추론 설정
inference:
  # 기본 추론 설정
  batch_size: 1
  confidence_threshold: 0.5  # Gender 예측 신뢰도 threshold
  
  # 출력 설정
  save_images: true
  visualize: true
  show_confidence: true
  
  # 출력 형식
  output_format: "json"  # json, csv
  output_path: "results/inference"

# ONNX Export 설정
onnx_export:
  # 기본 설정
  opset_version: 11
  dynamic_axes: false  # 동적 배치 크기 지원 여부
  
  # 입력/출력 이름
  input_names: ["input"]
  output_names: ["age_output", "gender_output"]
  
  # 최적화 옵션
  optimize: true
  simplify: true

# Head Detection 설정 (YOLO)
detection:
  # 모델 설정
  model: "yolo11n.pt"  # 사전 학습된 YOLO 모델
  trained_model: "weights/detection/best.pt"  # 학습된 head detection 모델 경로
  
  # 추론 설정
  conf_threshold: 0.25  # Confidence threshold
  iou_threshold: 0.45  # IoU threshold for NMS
  padding_ratio: 0.1  # Crop 시 추가할 padding 비율 (10%)
  
  # 데이터셋 설정 (YOLO format)
  data_yaml: "data/detection/dataset.yaml"  # YOLO format 데이터셋 설정 파일
  
  # 학습 설정
  train:
    epochs: 100
    imgsz: 640
    batch: 16
    device: null  # null이면 자동 선택
  
  # 출력 경로
  output_dir: "results/detection"

